---
- name: Creates a cron file under /etc/cron.d
  cron:
    name: slurm autoscaling
    minute: "*"
    user: '{{ ansible_user }}'
    job: "/opt/oci-hpc/autoscaling/crontab/autoscale_slurm.sh >> /opt/oci-hpc/logs/crontab_slurm_`date '+\\%Y\\%m\\%d'`.log 2>&1"
  when: autoscaling | bool

- name: Create a slurm monitoring cron file under /etc/cron.d
  cron:
    name: slurm monitoring
    minute: "*"
    user: '{{ ansible_user }}'
    job: "source /opt/oci-hpc/monitoring/env; /opt/oci-hpc/monitoring/monitor_slurm.sh >> /opt/oci-hpc/monitoring/monitor_slurm_`date '+\\%Y\\%m\\%d'`.log 2>&1"
  when: autoscaling_monitoring | bool

- name: Create a  OCI monitoring cron file under /etc/cron.d
  cron:
    name: OCI monitoring
    minute: "*"
    user: '{{ ansible_user }}'
    job: "source /opt/oci-hpc/monitoring/env; /opt/oci-hpc/monitoring/monitor_oci.sh >> /opt/oci-hpc/monitoring/monitor_oci_`date '+\\%Y\\%m\\%d'`.log 2>&1"
  when: autoscaling_monitoring | bool

- name: Creates a commented cron file under /etc/cron.d
  cron:
    name: slurm autoscaling
    minute: "#*"
    user: '{{ ansible_user }}'
    job: "#/opt/oci-hpc/autoscaling/crontab/autoscale_slurm.sh >> /opt/oci-hpc/logs/crontab_slurm_`date '+\\%Y\\%m\\%d'`.log 2>&1"
  when: not autoscaling | bool


- name: Create a commented Slurm monitoring cron file under /etc/cron.d
  cron:
    name: slurm monitoring
    minute: "*"
    user: '{{ ansible_user }}'
    job: "#source /opt/oci-hpc/monitoring/env; /opt/oci-hpc/monitoring/monitor_slurm.sh >> /opt/oci-hpc/monitoring/monitor_slurm_`date '+\\%Y\\%m\\%d'`.log 2>&1"
  when: not autoscaling_monitoring | bool

- name: Create a commented OCI monitoring cron file under /etc/cron.d
  cron:
    name: OCI monitoring
    minute: "*"
    user: '{{ ansible_user }}'
    job: "#source /opt/oci-hpc/monitoring/env; /opt/oci-hpc/monitoring/monitor_oci.sh >> /opt/oci-hpc/monitoring/monitor_oci_`date '+\\%Y\\%m\\%d'`.log 2>&1"
  when: not autoscaling_monitoring | bool


- name: Install daily oci-hpc cleanup cron script
  become: true
  copy:
    dest: /etc/cron.daily/oci-hpc-cleanup
    owner: root
    group: root
    mode: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      DIRS=(/opt/oci-hpc/autoscaling/clusters /opt/oci-hpc/logs /opt/oci-hpc/tmp)
      for d in "${DIRS[@]}"; do
        if [[ -d "$d" ]]; then
          find "$d" -mindepth 1 -maxdepth 1 -exec rm -rf {} + || true
        fi
      done
      journalctl --vacuum-time=3d || true
      if command -v dnf >/dev/null 2>&1; then dnf clean all -y >/dev/null 2>&1 || true; fi
      if command -v apt-get >/dev/null 2>&1; then apt-get clean >/dev/null 2>&1 || true; fi
      exit 0
